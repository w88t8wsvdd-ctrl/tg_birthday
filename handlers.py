import pandas as pd
import logging
import asyncio
from pathlib import Path
from telegram import Update
from telegram.ext import ContextTypes, MessageHandler, filters

from config import AUTHORIZED_USER_IDS, DATA_FILE
from utils import save_birthdays, parse_birthday_date, load_birthdays, get_upcoming_birthdays

logger = logging.getLogger(__name__)

async def handle_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–≥—Ä—É–∑–∫–∏ Excel-—Ñ–∞–π–ª–∞."""

    user_id = update.effective_user.id

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç—Ç–æ –¥–æ–∫—É–º–µ–Ω—Ç
    if not update.message.document:
        await update.message.reply_text("üìé –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ Excel-—Ñ–∞–π–ª (.xlsx).")
        return

    document = update.message.document

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞
    if not document.file_name.endswith('.xlsx'):
        await update.message.reply_text("‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –≤ —Ñ–æ—Ä–º–∞—Ç–µ .xlsx")
        return

    try:
        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file = await document.get_file()
        temp_path = Path(f"temp_{document.file_name}")
        await file.download_to_drive(temp_path)

        # –ß–∏—Ç–∞–µ–º Excel —Ñ–∞–π–ª
        df = pd.read_excel(temp_path, engine='openpyxl')

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω—É–∂–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫
        required_columns = ['–ò–º—è', '–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è']

        # –õ–æ–≥–∏—Ä—É–µ–º –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
        logger.info(f"–ö–æ–ª–æ–Ω–∫–∏ –≤ —Ñ–∞–π–ª–µ: {list(df.columns)}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–∑–≤–∞–Ω–∏—è –∫–æ–ª–æ–Ω–æ–∫ (–Ω–µ—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É –∏ –ø—Ä–æ–±–µ–ª–∞–º)
        df.columns = df.columns.str.strip()

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –Ω—É–∂–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏
        column_mapping = {}
        for col in df.columns:
            col_lower = col.lower()
            if '–∏–º—è' in col_lower or 'name' in col_lower:
                column_mapping['–ò–º—è'] = col
            elif '–¥–µ–Ω—å' in col_lower and '—Ä–æ–∂–¥' in col_lower or 'birthday' in col_lower or '–¥–∞—Ç–∞' in col_lower:
                column_mapping['–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è'] = col

        if not all(key in column_mapping for key in required_columns):
            await update.message.reply_text(
                f'‚ùå –§–∞–π–ª –¥–æ–ª–∂–µ–Ω —Å–æ–¥–µ—Ä–∂–∞—Ç—å —Å—Ç–æ–ª–±—Ü—ã "–ò–º—è" –∏ "–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è"\n'
                f'–ù–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏: {list(df.columns)}'
            )
            temp_path.unlink(missing_ok=True)
            return

        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤—ã–≤–∞–µ–º –∫–æ–ª–æ–Ω–∫–∏ –¥–ª—è –µ–¥–∏–Ω–æ–æ–±—Ä–∞–∑–∏—è
        df = df.rename(columns=column_mapping)

        # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        birthdays = []
        errors = []

        for idx, row in df.iterrows():
            try:
                name = str(row['–ò–º—è']).strip()
                if not name or name.lower() == 'nan':
                    continue

                birth_date = parse_birthday_date(row['–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è'])

                birthdays.append({
                    'name': name,
                    'birthday': birth_date
                })

            except Exception as e:
                error_name = str(row.get('–ò–º—è', f'–°—Ç—Ä–æ–∫–∞ {idx}')).strip()
                errors.append(error_name)
                logger.warning(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø–∏—Å–∏: {e}")

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ (–æ–±—â–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
        if birthdays:
            save_birthdays(birthdays, DATA_FILE)

            # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
            success_msg = f"‚úÖ –î–∞–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã! –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(birthdays)} –∑–∞–ø–∏—Å–µ–π."
            if errors:
                success_msg += f"\n‚ùå –û—à–∏–±–∫–∏ –≤ {len(errors)} –∑–∞–ø–∏—Å—è—Ö: {', '.join(errors[:5])}"
                if len(errors) > 5:
                    success_msg += f" –∏ –µ—â–µ {len(errors) - 5}"

            await update.message.reply_text(success_msg)
        else:
            await update.message.reply_text("‚ùå –í —Ñ–∞–π–ª–µ –Ω–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö")

        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        temp_path.unlink(missing_ok=True)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞")

        # –û—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã
        temp_path = Path(f"temp_{document.file_name}")
        temp_path.unlink(missing_ok=True)

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start."""
    user_id = update.effective_user.id
    
    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    await update.message.reply_text(
        "üëã **–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ Birthday Bot!** üéâ\n\n"
        
        "ü§ñ **–ß—Ç–æ —É–º–µ–µ—Ç —ç—Ç–æ—Ç –±–æ—Ç:**\n"
        "‚Ä¢ –ü—Ä–∏–Ω–∏–º–∞–µ—Ç Excel-—Ñ–∞–π–ª—ã —Å –¥–Ω—è–º–∏ —Ä–æ–∂–¥–µ–Ω–∏—è\n"
        "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ 09:00\n"
        "‚Ä¢ **–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è** –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞\n"
        "‚Ä¢ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è\n"
        "‚Ä¢ –•—Ä–∞–Ω–∏—Ç –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è\n\n"
        
        "üìé **–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç:**\n"
        "1. –û—Ç–ø—Ä–∞–≤—å—Ç–µ Excel-—Ñ–∞–π–ª —Å –¥–≤—É–º—è —Å—Ç–æ–ª–±—Ü–∞–º–∏:\n"
        "   ‚Ä¢ `–ò–º—è` (–Ω–∞–ø—Ä–∏–º–µ—Ä: –ê–Ω–Ω–∞)\n"
        "   ‚Ä¢ `–î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è` (—Ñ–æ—Ä–º–∞—Ç: `–î–î.–ú–ú`)\n"
        "2. –ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 09:00\n"
        "3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è\n\n"
        
        "üé≠ **–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç—å:** –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π!\n"
        "–ö–∞–∂–¥–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ –∏ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π.\n"
        "–ë–æ—Ç —É—á–∏—Ç—ã–≤–∞–µ—Ç –ø–æ–ª, —Å–µ–∑–æ–Ω –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç–º–æ–¥–∑–∏. üéÇ‚ú®\n\n"
        
        "‚å®Ô∏è **–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n"
        "‚Ä¢ `/help` - –ø–æ–ª–Ω–∞—è —Å–ø—Ä–∞–≤–∫–∞ —Å–æ –≤—Å–µ–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏\n"
        "‚Ä¢ `/nearest` - –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —Å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏\n"
        "‚Ä¢ `/list` - –≤–µ—Å—å —Å–ø–∏—Å–æ–∫ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è\n"
        "‚Ä¢ `/test` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞\n"
        "‚Ä¢ `/greet –ò–º—è` - —Ç–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π\n\n"
        
        "üöÄ **–ù–∞—á–Ω–∏—Ç–µ —Å –æ—Ç–ø—Ä–∞–≤–∫–∏ Excel-—Ñ–∞–π–ª–∞ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/help` –¥–ª—è –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–µ–π!**"
    )

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help."""
    user_id = update.effective_user.id
    
    if user_id not in AUTHORIZED_USER_IDS:
        return
    
    await update.message.reply_text(
        "üìã **–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:**\n\n"
        
        "üìé **–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö:**\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ Excel-—Ñ–∞–π–ª (.xlsx) —Å–æ —Å—Ç–æ–ª–±—Ü–∞–º–∏:\n"
        "‚Ä¢ –ò–º—è (—Ç–µ–∫—Å—Ç)\n"
        "‚Ä¢ –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è (—Ñ–æ—Ä–º–∞—Ç: –î–î.–ú–ú, –Ω–∞–ø—Ä–∏–º–µ—Ä: 15.03)\n\n"
        
        "‚å®Ô∏è **–ö–æ–º–∞–Ω–¥—ã:**\n"
        "‚Ä¢ `/start` - –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ\n"
        "‚Ä¢ `/help` - —ç—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "‚Ä¢ `/nearest` - –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ üéâ\n"
        "‚Ä¢ `/list` - –≤—Å–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è –ø–æ –ø–æ—Ä—è–¥–∫—É\n"
        "‚Ä¢ `/test` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞\n"
        "‚Ä¢ `/greet [–∏–º—è]` - —Ç–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è –∏–º–µ–Ω–∏\n\n"
        
        "üé≠ **–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π:**\n"
        "–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:\n"
        "‚Ä¢ **–ö–∞–∂–¥–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π**\n"
        "‚Ä¢ **–í—Å–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã** (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ)\n"
        "‚Ä¢ **–£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞** (–æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –∏–º–µ–Ω–∏)\n"
        "‚Ä¢ **–î–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–µ–∑–æ–Ω–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è** (–∑–∏–º–∞/–≤–µ—Å–Ω–∞/–ª–µ—Ç–æ/–æ—Å–µ–Ω—å)\n"
        "‚Ä¢ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä —ç–º–æ–¥–∑–∏** üéâ‚ú®üéÇ\n"
        "‚Ä¢ **–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è** –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–æ–≤\n\n"
        
        "üîß **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:**\n"
        "`/greet –ê–Ω–Ω–∞` - –ø–æ–∫–∞–∂–µ—Ç 3 —Ä–∞–∑–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ê–Ω–Ω—ã\n"
        "`/nearest` - –ø–æ–∫–∞–∂–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —Å –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏\n\n"
        
        "üìÖ **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**\n"
        "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ **09:00** –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –¥–Ω—è—Ö —Ä–æ–∂–¥–µ–Ω–∏—è\n"
        "–Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∏ –∑–∞–≤—Ç—Ä–∞ —Å **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏**!\n\n"
        
        "üîÑ **–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:**\n"
        "1. **–û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∏–º–µ–Ω–∏–Ω–Ω–∏–∫—É** - –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞—á–∞–ª–æ\n"
        "2. **–û—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ** - —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Ñ—Ä–∞–∑–∞\n"
        "3. **1-2 –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∂–µ–ª–∞–Ω–∏—è** - –∑–¥–æ—Ä–æ–≤—å–µ, —É—Å–ø–µ—Ö, —Å—á–∞—Å—Ç—å–µ\n"
        "4. **–ó–∞–≤–µ—Ä—à–∞—é—â–∞—è —Ñ—Ä–∞–∑–∞** (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) - —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ –ø–æ–∂–µ–ª–∞–Ω–∏–µ\n"
        "5. **–≠–º–æ–¥–∑–∏** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏\n\n"
        
        "üéØ **–ü—Ä–∏–º–µ—Ä –≥–æ—Ç–æ–≤–æ–≥–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:**\n"
        "```\n"
        "–î–æ—Ä–æ–≥–∞—è –ê–Ω–Ω–∞, —Å —Ç–µ–ø–ª–æ—Ç–æ–π –≤ —Å–µ—Ä–¥—Ü–µ –ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º\n"
        "—Ç–µ–±—è —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ñ–µ–ª–∞–µ–º –∫—Ä–µ–ø–∫–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è,\n"
        "–ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —É—Å–ø–µ—Ö–æ–≤ –∏ –ª–∏—á–Ω–æ–≥–æ —Å—á–∞—Å—Ç—å—è!\n"
        "–ü—É—Å—Ç—å –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –±—É–¥–µ—Ç –Ω–∞–ø–æ–ª–Ω–µ–Ω —Ä–∞–¥–æ—Å—Ç—å—é! üéâ‚ú®üéÇ\n"
        "```\n\n"
        
        "üîÑ **–í–∞–∂–Ω–æ:**\n"
        "‚Ä¢ –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–æ–≤–æ–≥–æ —Ñ–∞–π–ª–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ\n"
        "‚Ä¢ –í—Å–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Ä–∞–±–æ—Ç–∞—é—Ç —Å –æ–±—â–∏–º —Å–ø–∏—Å–∫–æ–º\n"
        "‚Ä¢ –ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ –≤—Ä–µ–º–µ–Ω–∏ —Å–µ—Ä–≤–µ—Ä–∞ (UTC)\n\n"
        
        "üìä **–ü—Ä–∏–º–µ—Ä —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:**\n"
        "```\n"
        "| –ò–º—è       | –î–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è |\n"
        "|-----------|---------------|\n"
        "| –ê–Ω–Ω–∞      | 15.03         |\n"
        "| –ò–≤–∞–Ω      | 22.11         |\n"
        "| –ú–∞—Ä–∏—è     | 01.07         |\n"
        "```\n\n"
        
        "‚ùì **–ù—É–∂–Ω–∞ –ø–æ–º–æ—â—å?**\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/test` –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/greet –ò–º—è` –¥–ª—è —Ç–µ—Å—Ç–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/nearest` –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –±–ª–∏–∂–∞–π—à–∏—Ö –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è"
    )

async def nearest_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /nearest - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è."""
    user_id = update.effective_user.id

    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return

    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        birthdays = load_birthdays(DATA_FILE)

        if not birthdays:
            await update.message.reply_text("üì≠ –°–ø–∏—Å–æ–∫ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è –ø—É—Å—Ç.\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ Excel-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏.")
            return

        # –ü–æ–ª—É—á–∞–µ–º –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è (–Ω–∞ 7 –¥–Ω–µ–π –≤–ø–µ—Ä–µ–¥)
        upcoming = get_upcoming_birthdays(birthdays, days_ahead=7)

        if not upcoming:
            await update.message.reply_text(
                "üìÖ –ù–∞ –±–ª–∏–∂–∞–π—à—É—é –Ω–µ–¥–µ–ª—é –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è –Ω–µ—Ç.\n"
                "–°–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å —Ä–æ–∂–¥–µ–Ω–∏—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω –≤ –µ–∂–µ–¥–Ω–µ–≤–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è—Ö."
            )
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_lines = ["üìÖ **–ë–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è:**\n"]

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –¥–Ω—è–º
        current_day = None
        for bd in upcoming:
            if bd['day_description'] != current_day:
                if bd['day_offset'] == 0:
                    message_lines.append(f"\nüéÇ **–°–µ–≥–æ–¥–Ω—è ({bd['date']})**:")
                elif bd['day_offset'] == 1:
                    message_lines.append(f"\nüìÜ **–ó–∞–≤—Ç—Ä–∞ ({bd['date']})**:")
                elif bd['day_offset'] == 2:
                    message_lines.append(f"\nüìÜ **–ü–æ—Å–ª–µ–∑–∞–≤—Ç—Ä–∞ ({bd['date']})**:")
                else:
                    day_word = "–¥–Ω–µ–π" if bd['day_offset'] > 4 else "–¥–Ω—è"
                    message_lines.append(f"\nüìÜ **{bd['date']}** (—á–µ—Ä–µ–∑ {bd['day_offset']} {day_word}):")
                current_day = bd['day_description']

            message_lines.append(f"  ‚Ä¢ {bd['name']}")

        # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        today_birthdays = [b for b in upcoming if b['day_offset'] == 0]
        tomorrow_birthdays = [b for b in upcoming if b['day_offset'] == 1]

        if today_birthdays:
            message_lines.append(f"\nüéâ –°–µ–≥–æ–¥–Ω—è –ø—Ä–∞–∑–¥–Ω—É—é—Ç: {len(today_birthdays)} —á–µ–ª–æ–≤–µ–∫")
        if tomorrow_birthdays:
            message_lines.append(f"üìà –ó–∞–≤—Ç—Ä–∞ –ø—Ä–∞–∑–¥–Ω—É—é—Ç: {len(tomorrow_birthdays)} —á–µ–ª–æ–≤–µ–∫")

        message_lines.append(f"\n–í—Å–µ–≥–æ –≤ –±–ª–∏–∂–∞–π—à–∏–µ 7 –¥–Ω–µ–π: {len(upcoming)} –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è")

        await update.message.reply_text("\n".join(message_lines))

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /nearest: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö")

async def list_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /list - –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è."""
    user_id = update.effective_user.id

    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return

    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        birthdays = load_birthdays(DATA_FILE)

        if not birthdays:
            await update.message.reply_text("üì≠ –°–ø–∏—Å–æ–∫ –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è –ø—É—Å—Ç.\n–û—Ç–ø—Ä–∞–≤—å—Ç–µ Excel-—Ñ–∞–π–ª —Å –¥–∞–Ω–Ω—ã–º–∏.")
            return

        # –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –¥–∞—Ç–µ (–ø–æ –º–µ—Å—è—Ü—É –∏ –¥–Ω—é)
        def sort_key(bd):
            day, month = map(int, bd['birthday'].split('.'))
            return (month, day)

        sorted_birthdays = sorted(birthdays, key=sort_key)

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message_lines = [f"üìã **–í—Å–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è** ({len(sorted_birthdays)} –∑–∞–ø–∏—Å–µ–π):\n"]

        # –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º
        months = {
            1: "–Ø–Ω–≤–∞—Ä—å", 2: "–§–µ–≤—Ä–∞–ª—å", 3: "–ú–∞—Ä—Ç", 4: "–ê–ø—Ä–µ–ª—å",
            5: "–ú–∞–π", 6: "–ò—é–Ω—å", 7: "–ò—é–ª—å", 8: "–ê–≤–≥—É—Å—Ç",
            9: "–°–µ–Ω—Ç—è–±—Ä—å", 10: "–û–∫—Ç—è–±—Ä—å", 11: "–ù–æ—è–±—Ä—å", 12: "–î–µ–∫–∞–±—Ä—å"
        }

        current_month = None
        for bd in sorted_birthdays:
            month = int(bd['birthday'].split('.')[1])
            if month != current_month:
                message_lines.append(f"\n**{months[month]}**:")
                current_month = month

            message_lines.append(f"  {bd['birthday']} - {bd['name']}")

        # –ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ, —Ä–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏
        message_text = "\n".join(message_lines)
        if len(message_text) > 4000:  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram
            # –†–∞–∑–±–∏–≤–∞–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º
            parts = []
            current_part = []
            current_length = 0

            for line in message_lines:
                if current_length + len(line) + 1 > 4000:
                    parts.append("\n".join(current_part))
                    current_part = [line]
                    current_length = len(line) + 1
                else:
                    current_part.append(line)
                    current_length += len(line) + 1

            if current_part:
                parts.append("\n".join(current_part))

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–≤—É—é —á–∞—Å—Ç—å
            await update.message.reply_text(parts[0])

            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Å—Ç–∞–ª—å–Ω—ã–µ —á–∞—Å—Ç–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            for part in parts[1:]:
                await asyncio.sleep(0.5)
                await update.message.reply_text(part)
        else:
            await update.message.reply_text(message_text)

    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /list: {e}")
        await update.message.reply_text("‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö")

async def test_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞."""
    user_id = update.effective_user.id
    
    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞.")
        return
    
    try:
        from utils import load_birthdays, get_today_date, get_tomorrow_date
        from config import DATA_FILE
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
        birthdays = load_birthdays(DATA_FILE)
        
        if not birthdays:
            await update.message.reply_text("üì≠ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª.")
            return
        
        # –ü–æ–ª—É—á–∞–µ–º –¥–∞—Ç—ã
        today = get_today_date()
        tomorrow = get_tomorrow_date()
        
        # –ò—â–µ–º —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è
        today_birthdays = [b['name'] for b in birthdays if b['birthday'] == today]
        tomorrow_birthdays = [b['name'] for b in birthdays if b['birthday'] == tomorrow]
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = [
            "üîß **–¢–ï–°–¢ –ü–õ–ê–ù–ò–†–û–í–©–ò–ö–ê**",
            f"üìÖ –î–∞—Ç–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: {today}",
            f"üìä –í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: {len(birthdays)}",
            "",
            "üéÇ **–°–µ–≥–æ–¥–Ω—è:**",
            f"‚Ä¢ –°–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(today_birthdays)}",
            f"‚Ä¢ –ò–º–µ–Ω–∞: {', '.join(today_birthdays) if today_birthdays else '–Ω–µ—Ç'}",
            "",
            "üìÖ **–ó–∞–≤—Ç—Ä–∞:**",
            f"‚Ä¢ –°–æ–≤–ø–∞–¥–µ–Ω–∏–π: {len(tomorrow_birthdays)}",
            f"‚Ä¢ –ò–º–µ–Ω–∞: {', '.join(tomorrow_birthdays) if tomorrow_birthdays else '–Ω–µ—Ç'}",
            "",
            "‚úÖ **–ß—Ç–æ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ 09:00:**",
            ""
        ]
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫
        try:
            # –ü—Ä–æ–±—É–µ–º –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å format_birthday_message –µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å
            from utils import format_birthday_message
            
            if today_birthdays:
                today_msg = format_birthday_message(today_birthdays, is_today=True)
                message.append(f"‚Ä¢ –°–µ–≥–æ–¥–Ω—è:\n{today_msg}")
            
            if tomorrow_birthdays:
                tomorrow_msg = format_birthday_message(tomorrow_birthdays, is_today=False)
                message.append(f"\n‚Ä¢ –ó–∞–≤—Ç—Ä–∞:\n{tomorrow_msg}")
            
        except ImportError:
            # –ï—Å–ª–∏ format_birthday_message –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ—Å—Ç–æ –∏–º–µ–Ω–∞
            if today_birthdays:
                message.append(f"‚Ä¢ –°–µ–≥–æ–¥–Ω—è: {', '.join(today_birthdays)}")
            
            if tomorrow_birthdays:
                message.append(f"‚Ä¢ –ó–∞–≤—Ç—Ä–∞: {', '.join(tomorrow_birthdays)}")
        
        if not today_birthdays and not tomorrow_birthdays:
            message.append("‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ –±—É–¥–µ—Ç (–Ω–µ—Ç –¥–Ω–µ–π —Ä–æ–∂–¥–µ–Ω–∏—è)")
        
        await update.message.reply_text("\n".join(message))
        
    except Exception as e:
        await update.message.reply_text(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")

async def greet_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /greet - —Ç–µ—Å—Ç–∏—Ä—É–µ—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π."""
    user_id = update.effective_user.id
    
    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    try:
        # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –æ—à–∏–±–æ–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        try:
            from greetings_generator import generate_greeting, generate_collective_greeting
            generator_available = True
        except ImportError:
            generator_available = False
            await update.message.reply_text(
                "‚ö†Ô∏è –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω.\n"
                "–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ greetings_generator.py"
            )
            return
        
        # –ï—Å–ª–∏ –ø–µ—Ä–µ–¥–∞–Ω –∞—Ä–≥—É–º–µ–Ω—Ç - –∏–º—è –¥–ª—è —Ç–µ—Å—Ç–∞
        if context.args:
            name = " ".join(context.args)
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π
            message_lines = [
                f"üé≠ **–¢–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π –¥–ª—è '{name}':**\n",
                "**–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è (–∫–∞–∂–¥–æ–µ —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ):**"
            ]
            
            # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 3 —Ä–∞–∑–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
            for i in range(1, 4):
                try:
                    greeting = generate_greeting(name, min_sentences=3, max_sentences=5)
                    message_lines.append(f"\n{i}. {greeting}")
                except Exception as e:
                    message_lines.append(f"\n{i}. ‚ùå –û—à–∏–±–∫–∞: {str(e)}")
            
            # –¢–µ—Å—Ç –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è
            message_lines.append(f"\n**–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ (—Ç–µ—Å—Ç):**")
            try:
                test_names = [name, "–ò–≤–∞–Ω", "–ú–∞—Ä–∏—è"]
                collective = generate_collective_greeting(test_names)
                message_lines.append(f"\n{collective}")
            except Exception as e:
                message_lines.append(f"\n‚ùå –û—à–∏–±–∫–∞ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è: {str(e)}")
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            full_message = "\n".join(message_lines)
            
            # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏ –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ (–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ Telegram 4096 —Å–∏–º–≤–æ–ª–æ–≤)
            if len(full_message) > 4000:
                part1 = full_message[:4000]
                part2 = full_message[4000:]
                await update.message.reply_text(part1)
                await asyncio.sleep(0.5)
                await update.message.reply_text(part2[:4000] if len(part2) > 4000 else part2)
            else:
                await update.message.reply_text(full_message)
            
        else:
            # –ë–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ - –æ–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
            message_lines = [
                "üé≠ **–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π:**\n",
                "–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.",
                "",
                "**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**",
                "‚Ä¢ –ö–∞–∂–¥–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ 3-5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π",
                "‚Ä¢ –í—Å–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–µ)",
                "‚Ä¢ –£—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –ø–æ–ª –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞ (–ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –∏–º–µ–Ω–∏)",
                "‚Ä¢ –î–æ–±–∞–≤–ª—è—é—Ç—Å—è —Å–µ–∑–æ–Ω–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è",
                "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–±–∏—Ä–∞—é—Ç—Å—è —ç–º–æ–¥–∑–∏ üéâ‚ú®üéÇ",
                "",
                "**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**",
                "‚Ä¢ `/greet [–∏–º—è]` - —Ç–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –∏–º–µ–Ω–∏",
                "‚Ä¢ `/nearest` - –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏ —Ä–æ–∂–¥–µ–Ω–∏—è —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏",
                "‚Ä¢ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ 09:00",
                "",
                "**–ü—Ä–∏–º–µ—Ä—ã:**",
                "`/greet –ê–Ω–Ω–∞` - –ø–æ–∫–∞–∂–µ—Ç 3 —Ä–∞–∑–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ê–Ω–Ω—ã",
                "`/greet –ò–≤–∞–Ω` - –ø–æ–∫–∞–∂–µ—Ç 3 —Ä–∞–∑–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –ò–≤–∞–Ω–∞",
                "",
                "**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:**",
                "1. –û–±—Ä–∞—â–µ–Ω–∏–µ –∫ –∏–º–µ–Ω–∏–Ω–Ω–∏–∫—É",
                "2. –û—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ",
                "3. 1-2 –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–∂–µ–ª–∞–Ω–∏—è",
                "4. –ó–∞–≤–µ—Ä—à–∞—é—â–∞—è —Ñ—Ä–∞–∑–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)",
            ]
            
            await update.message.reply_text("\n".join(message_lines))
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ –∫–æ–º–∞–Ω–¥–µ /greet: {e}", exc_info=True)
        await update.message.reply_text(f"‚ùå –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {str(e)}")
        
async def about_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /about - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∏—Å—Ç–µ–º–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏."""
    user_id = update.effective_user.id
    
    if user_id not in AUTHORIZED_USER_IDS:
        await update.message.reply_text("üö´ –£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–º—É –±–æ—Ç—É.")
        return
    
    await update.message.reply_text(
        "üé≠ **–°–∏—Å—Ç–µ–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π**\n\n"
        
        "ü§ñ **–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:**\n"
        "–ë–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–Ω—ã–π –ø–æ–¥—Ö–æ–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π.\n"
        "–ö–∞–∂–¥–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤.\n\n"
        
        "üß© **–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã:**\n"
        "1. **–ù–∞—á–∞–ª–∞ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π** (8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)\n"
        "   –ü—Ä–∏–º–µ—Ä: '–î–æ—Ä–æ–≥–æ–π {name}, –æ—Ç –≤—Å–µ–π –¥—É—à–∏'\n\n"
        "2. **–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è** (6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)\n"
        "   –ü—Ä–∏–º–µ—Ä: '–ø–æ–∑–¥—Ä–∞–≤–ª—è–µ–º —Ç–µ–±—è —Å –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è!'\n\n"
        "3. **–ü–æ–∂–µ–ª–∞–Ω–∏—è –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º** (15+ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤):\n"
        "   ‚Ä¢ –ó–¥–æ—Ä–æ–≤—å–µ (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)\n"
        "   ‚Ä¢ –£—Å–ø–µ—Ö –∏ –∫–∞—Ä—å–µ—Ä–∞ (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)\n"
        "   ‚Ä¢ –õ–∏—á–Ω–æ–µ —Å—á–∞—Å—Ç—å–µ (3 –≤–∞—Ä–∏–∞–Ω—Ç–∞)\n"
        "   ‚Ä¢ –§–∏–Ω–∞–Ω—Å—ã (2 –≤–∞—Ä–∏–∞–Ω—Ç–∞)\n"
        "   ‚Ä¢ –û–±—â–∏–µ (4 –≤–∞—Ä–∏–∞–Ω—Ç–∞)\n\n"
        "4. **–ì–µ–Ω–¥–µ—Ä–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è** (4 –∂–µ–Ω—Å–∫–∏—Ö + 4 –º—É–∂—Å–∫–∏—Ö)\n"
        "5. **–°–µ–∑–æ–Ω–Ω—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è** (–ø–æ 2 –Ω–∞ –∫–∞–∂–¥—ã–π —Å–µ–∑–æ–Ω)\n"
        "6. **–ó–∞–≤–µ—Ä—à–µ–Ω–∏—è** (6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤)\n"
        "7. **–≠–º–æ–¥–∑–∏ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º** (5 –∫–∞—Ç–µ–≥–æ—Ä–∏–π)\n\n"
        
        "üîß **–ü—Ä–æ—Ü–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≥–æ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:**\n"
        "1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ–ª –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–∞ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—é –∏–º–µ–Ω–∏\n"
        "2. –í—ã–±–∏—Ä–∞–µ—Ç—Å—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –Ω–∞—á–∞–ª–æ\n"
        "3. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ\n"
        "4. –ü–æ–¥–±–∏—Ä–∞–µ—Ç—Å—è 1-2 —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–∂–µ–ª–∞–Ω–∏—è\n"
        "5. –î–æ–±–∞–≤–ª—è–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ (—Å —à–∞–Ω—Å–æ–º 50%)\n"
        "6. –ü–æ–¥–±–∏—Ä–∞—é—Ç—Å—è —ç–º–æ–¥–∑–∏ (—Å —à–∞–Ω—Å–æ–º 70%)\n\n"
        
        "üéØ **–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞ —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏:**\n"
        "‚Ä¢ –ù–∞—á–∞–ª–∞: 8 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\n"
        "‚Ä¢ –û—Å–Ω–æ–≤–Ω—ã–µ: 6 –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\n"
        "‚Ä¢ –ü–æ–∂–µ–ª–∞–Ω–∏—è: 15+ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤\n"
        "‚Ä¢ –ò—Ç–æ–≥–æ –∫–æ–º–±–∏–Ω–∞—Ü–∏–π: 8 √ó 6 √ó 15 √ó 14 = **–±–æ–ª–µ–µ 10,000**\n"
        "(–µ—Å–ª–∏ –±—Ä–∞—Ç—å 2 –ø–æ–∂–µ–ª–∞–Ω–∏—è –∏–∑ 15 —Å –∏—Å–∫–ª—é—á–µ–Ω–∏–µ–º –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π)\n\n"
        
        "üåà **–°–µ–∑–æ–Ω–Ω–æ—Å—Ç—å:**\n"
        "–ë–æ—Ç –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–µ–∫—É—â–∏–π —Å–µ–∑–æ–Ω –∏ –¥–æ–±–∞–≤–ª—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è:\n"
        "‚Ä¢ ‚ùÑÔ∏è –ó–∏–º–∞ - –Ω–æ–≤–æ–≥–æ–¥–Ω–∏–µ –∏ –∑–∏–º–Ω–∏–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è\n"
        "‚Ä¢ üå∏ –í–µ—Å–Ω–∞ - –ø–æ–∂–µ–ª–∞–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ —Ä–æ—Å—Ç–∞\n"
        "‚Ä¢ ‚òÄÔ∏è –õ–µ—Ç–æ - —Å–æ–ª–Ω–µ—á–Ω—ã–µ –∏ —Ç–µ–ø–ª—ã–µ –ø–æ–∂–µ–ª–∞–Ω–∏—è\n"
        "‚Ä¢ üçÇ –û—Å–µ–Ω—å - –ø–æ–∂–µ–ª–∞–Ω–∏—è –º—É–¥—Ä–æ—Å—Ç–∏ –∏ —É—Ä–æ–∂–∞—è\n\n"
        
        "üë• **–ö–æ–ª–ª–µ–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è:**\n"
        "–î–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏–º–µ–Ω–∏–Ω–Ω–∏–∫–æ–≤ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ –∫–æ–ª–ª–µ–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ\n"
        "—Å –æ–±—Ä–∞—â–µ–Ω–∏–µ–º –∫–æ –≤—Å–µ–º –∏ –æ–±—â–∏–º–∏ –ø–æ–∂–µ–ª–∞–Ω–∏—è–º–∏.\n\n"
        
        "üß™ **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ:**\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `/greet –ê–Ω–Ω–∞` –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ 3 —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–π.\n"
        "–ö–∞–∂–¥—ã–π –∑–∞–ø—É—Å–∫ —Å–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∫–æ–º–±–∏–Ω–∞—Ü–∏–∏!\n\n"
        
        "‚öôÔ∏è **–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏:**\n"
        "‚Ä¢ –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è\n"
        "‚Ä¢ –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞: 5 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π\n"
        "‚Ä¢ –°–∏—Å—Ç–µ–º–∞ –∏–∑–±–µ–≥–∞–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤\n"
        "‚Ä¢ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –æ–¥–Ω–æ–º —Ñ–∞–π–ª–µ\n"
        "‚Ä¢ –õ–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ—Ç—Å—è –Ω–æ–≤—ã–º–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞–º–∏\n\n"
        
        "üìà **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —ç—Ç–æ–π —Å–∏—Å—Ç–µ–º—ã:**\n"
        "‚úÖ –ù–µ –Ω–∞–¥–æ–µ–¥–∞–µ—Ç - –≤—Å–µ–≥–¥–∞ —Ä–∞–∑–Ω—ã–µ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏—è\n"
        "‚úÖ –ö–æ–Ω—Ç—Ä–æ–ª—å –∫–∞—á–µ—Å—Ç–≤–∞ - –≤—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã\n"
        "‚úÖ –ì–∏–±–∫–æ—Å—Ç—å - –ª–µ–≥–∫–æ –¥–æ–±–∞–≤–ª—è—Ç—å –Ω–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã\n"
        "‚úÖ –≠—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤–µ—Å –∫–æ–¥–∞\n"
        "‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∞—Ü–∏—è - —É—á–µ—Ç –ø–æ–ª–∞ –∏ —Å–µ–∑–æ–Ω–∞\n\n"
        
        "üîç **–ü–æ–¥—Ä–æ–±–Ω–µ–µ:** `/greet [–∏–º—è]` - —Ç–µ—Å—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏\n"
        "üìã **–í—Å–µ –∫–æ–º–∞–Ω–¥—ã:** `/help`"
    )
    
